#!/usr/bin/env zsh

prog_name=$0
target_spec=$1

function usage() {
  echo "$prog_name <target_spec>"
  echo "Sets up my dotfiles on the remote host"
}

if [[ $# -ne 1 ]]; then
  echo "Expected a single argument"
  usage
  exit 1
fi

SCRIPT_DIR=$(unset CDPATH; cd "$(dirname "$0")" > /dev/null; pwd -P)

original_url=$(git --work-tree "$SCRIPT_DIR" remote get-url origin)

ssh "$target_spec" "/bin/true"
rsync ~/./.gitconfig_credentials "$target_spec:~/.gitconfig_credentials"
rsync ~/./.color/current "$target_spec:~/.color/current" --rsync-path "mkdir -p ~/.color && rsync"
ssh -tA "$target_spec" "git clone '$original_url' ~/.dotfiles; cd ~/.dotfiles && DOTFILES_PROFILE=minimal ./script/bootstrap"
